#!/bin/bash

. function.sh

BAR
CODE '[U-20] Anonymous FTP 비활성화'
cat << EOF >> $RESULT
[양호]: Anonymous FTP (익명 ftp) 접속을 차단한 경우
[취약]: Anonymous FTP (익명 ftp) 접속을 차단하지 않은 경우
EOF
BAR

# 1) ftp 사용자 존재 유무 파악
#   * # grep ftp /etc/passwd
# 2) ftp 서버 프로그램 파악
#   * # rpm -q vsftpd proftpd
#     -> vsftpd, proftpd -> script check
#     -> other ftp solution -> 고객과 상의
# 3) ftp server primary configuration file
#   * # systemctl list-unit-files | egrep 'vsftpd.service|proftpd.service'
#   * # systemctl is-active vsftpd.service proftpd.service
#   * # rpm -qc vsftpd
# 4) anonymous ftp configuration check
#   * # cat /etc/vsftpd/vsftpd.conf (anonymous_enable = YES)
#   * # cat /etc/proftpd.conf(User ftp, UserAlias anonymous ftp)
#      
USERFILE=/etc/passwd
PKG_VSFTPD=vsftpd
PKG_PROFTPD=proftpd

FTPTYPE_FINDPATTERN() {
Service=$1
if [ $Service = 'vsftpd' ] ; then
    ANON_ENABLE=$(FindPattern $FTPCONF_FILE 'anonymous_enable')
    if [ "$ANON_ENABLE" = 'YES' ] ; then
        Return='BAD'
    else
        Return='GOOD'
    fi
elif [ $Service = 'proftpd' ] ; then
    ANON_ENABLE=$(echo $(egrep -v '^#|.*#.*|^$' $FTPCONF_FILE | sed -n '/<IfDefine ANONYMOUS_FTP>/,$p' | grep -w User))
    if [ "$ANON_ENABLE" = 'User ftp' ]; then
        Return='BAD'
    else
        Return="GOOD"
    fi
else
    echo "[ ERROR ] Unkown Service : $Service"
    exit 2
fi

echo $Return
}

if grep -q '^ftp:' $USERFILE; then
    INFO "FTP 서비스가 존재합니다."
    PKGLIST=$(rpm -q $PKG_VSFTPD $PKG_PROFTPD | egrep -v 'not installed' | awk -F- '{print $1}')
    # echo $PKGLIST
    for PKG in $PKGLIST
    do
        STATUS=$(systemctl is-active $PKG) 
        [ $STATUS = 'active' ] && CHKSERVICE=$PKG
    done
    # echo $CHKSERVICE
    FTPCONF_FILE=$(rpm -qc $CHKSERVICE | grep .conf)
    EVAL=$(FTPTYPE_FINDPATTERN $CHKSERVICE)
    if [ "$EVAL" = 'BAD' ] ; then
        VUL "FTP 서비스에 Anonymous FTP 설정이 되어 있습니다."
    elif [ "$EVAL" = 'GOOD' ] ; then
        OK "FTP 서비스에 Anonymous FTP 설정이 되어 있지 않습니다."
    else
        echo "[ ERROR ] 서비스를 판별할 수 없습니다."
        exit 3
    fi
else
    OK "FTP 서비스가 없습니다."
fi

cat $RESULT
